<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Conferir gabarito (bolinhas)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  >

  <style>
    * {
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    :root {
      --line:#e5e7eb;
      --card:#fff;
    }

    /* Acessibilidade visual dos focos e estado ativo da nav */
    .focus-ring {
      outline: 2px solid transparent;
      outline-offset: 2px;
    }
    .focus-ring:focus {
      box-shadow: 0 0 0 4px rgba(59,130,246,.35);
    }
    .nav-link-active {
      background:#f1f5f9;
      color:#0f172a;
      font-weight:600;
    }

    .canvas-wrap{
      position:relative;
      display:inline-block;
      background:#fff;
      border:1px solid var(--line);
      border-radius:12px;
      overflow:hidden;
      box-shadow:0 8px 24px rgba(0,0,0,.06);
    }
    #sheet{
      display:block;
      max-width:100%;
      height:auto;
      z-index:0;
      position:relative;
    }
    #overlay{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      pointer-events:auto;
      z-index:1;
    }
    .dot{
      fill:rgba(255,0,0,.95);
      stroke:rgba(255,0,0,.95);
      stroke-width:2;
      pointer-events:auto;
    }
    .dot.inactive{
      fill:rgba(255,0,0,.12);
      stroke:rgba(255,0,0,.35);
    }
    .crosshair{
      cursor:crosshair;
    }
    .kbd{
      font: 12px/1.4 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      background:#f3f4f6;
      border:1px solid var(--line);
      padding:2px 6px;
      border-radius:6px;
    }
    .q-input{
      width:3rem;
      text-transform:uppercase;
      text-align:center;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 text-slate-800">

  {% include 'partials/navbar.html' %}

  <!-- CONTEÚDO -->
  <main class="mx-auto max-w-6xl px-6 pt-20 md:pt-8">
    <h1 class="text-2xl font-semibold tracking-tight mb-4">Conferir gabarito (bolinhas)</h1>
    <span class="text-sm text-slate-600">
      Clique nas bolinhas para marcar/desmarcar • Remover:
      <span class="kbd">Ctrl</span>+Clique
    </span>

    <!-- TOOLS BAR 100% -->
    <section class="rounded-xl border border-slate-200 bg-white p-4 shadow-sm mb-6">
      <div class="flex flex-wrap items-center gap-3 w-full">
        <div class="ml-auto flex items-center gap-2">
          <button
            id="btnDetect"
            class="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-medium hover:bg-slate-50"
          >
            Carregar bolinhas
          </button>
          <button
            id="btnAdd"
            class="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-medium hover:bg-slate-50"
            title="A"
          >
            Adicionar (A)
          </button>
          <label class="text-sm text-slate-600 flex items-center gap-2">
            Raio novas:
            <input id="radius" type="range" min="4" max="40" value="12" class="w-40">
            <span id="radiusVal" class="tabular-nums">12</span>px
          </label>
          <label class="text-sm text-slate-600 flex items-center gap-2">
            <input id="chkFilter" type="checkbox" class="h-4 w-4 accent-blue-600" checked>
            Filtrar por escuridão na imagem
          </label>
        </div>
        <button
          id="btnToggleAll"
          class="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-medium hover:bg-slate-50"
        >
          Alternar tudo
        </button>
        <button
          id="btnSave"
          class="rounded-lg bg-blue-600 px-3 py-2 text-sm font-semibold text-white hover:bg-blue-700"
        >
          Salvar
        </button>
      </div>
    </section>

    <!-- DUAS COLUNAS -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
      <!-- ESQUERDA: imagem -->
      <section>
        <div class="flex items-center gap-2">
          <button
            id="btnPrev"
            class="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-medium hover:bg-slate-50"
            title="Anterior (←)"
          >
            Anterior
          </button>
          <button
            id="btnNext"
            class="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-medium hover:bg-slate-50"
            title="Próximo (→)"
          >
            Próximo
          </button>
        </div>
        <div class="canvas-wrap mt-3">
          {% if imagem_url %}
            <img id="sheet" src="{{ imagem_url }}" alt="Gabarito" />
            <svg id="overlay" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet"></svg>
          {% else %}
            <div class="p-6 text-slate-600">
              <p class="font-semibold text-rose-700">Nenhuma imagem encontrada.</p>
              <p>
                Coloque <code>image.png</code> em <code>/uploads</code> ou no diretório raiz e recarregue.
              </p>
            </div>
          {% endif %}
        </div>
        <p id="status" class="text-sm text-slate-600 min-h-[20px] mt-3"></p>
        <div class="flex items-center gap-2 mt-2">
          <button
            id="btnPrev"
            class="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-medium hover:bg-slate-50"
            title="Anterior (←)"
          >
            Anterior
          </button>
          <button
            id="btnNext"
            class="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-medium hover:bg-slate-50"
            title="Próximo (→)"
          >
            Próximo
          </button>
        </div>
      </section>

      <!-- DIREITA: formulário + gabarito -->
      <aside class="space-y-4">
        <div class="rounded-xl border border-slate-200 bg-white p-5 shadow-sm">
          <h2 class="text-base font-semibold mb-3">Dados do aluno</h2>
          <div class="grid grid-cols-1 gap-4">
            <div>
              <label for="nomeInput" class="block text-sm font-medium text-slate-700 mb-1">Nome</label>
              <input
                id="nomeInput"
                type="text"
                placeholder="Digite o nome completo"
                class="w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <div>
              <label for="cpfInput" class="block text-sm font-medium text-slate-700 mb-1">CPF</label>
              <input
                id="cpfInput"
                type="text"
                inputmode="numeric"
                placeholder="Somente números"
                class="w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <div>
              <div class="text-sm font-medium text-slate-700 mb-1">Tipo</div>
              <div class="flex flex-wrap gap-2">
                <label class="inline-flex items-center gap-2 rounded-full border border-slate-300 bg-white px-3 py-2 text-sm">
                  <input type="radio" name="tipo" value="Candidato" class="h-4 w-4 accent-blue-600" checked>
                  Candidato
                </label>
                <label class="inline-flex items-center gap-2 rounded-full border border-slate-300 bg-white px-3 py-2 text-sm">
                  <input type="radio" name="tipo" value="Ex-aluno" class="h-4 w-4 accent-blue-600">
                  Ex-aluno
                </label>
                <label class="inline-flex items-center gap-2 rounded-full border border-slate-300 bg-white px-3 py-2 text-sm">
                  <input type="radio" name="tipo" value="Remanescente" class="h-4 w-4 accent-blue-600">
                  Remanescente
                </label>
              </div>
            </div>
            <div>
              <div class="text-sm font-medium text-slate-700 mb-1">Cor</div>
              <div class="flex flex-wrap gap-2">
                <label class="inline-flex items-center gap-2 rounded-full border border-slate-300 bg-white px-3 py-2 text-sm">
                  <input type="radio" name="cor" value="Amarelo" class="h-4 w-4 accent-blue-600" checked>
                  Amarelo
                </label>
                <label class="inline-flex items-center gap-2 rounded-full border border-slate-300 bg-white px-3 py-2 text-sm">
                  <input type="radio" name="cor" value="Azul" class="h-4 w-4 accent-blue-600">
                  Azul
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- GABARITO TRANSCRITO -->
        <div class="rounded-xl border border-slate-200 bg-white p-5 shadow-sm">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-base font-semibold">Gabarito transcrito (1–60)</h2>
            <div class="text-xs text-slate-500">Use Anterior/Próximo ou setas ← →</div>
          </div>
          <div id="gabaritoBox" class="columns-2 md:columns-4 gap-x-6"></div>
        </div>

        <div class="rounded-xl border border-slate-200 bg-white p-4 shadow-sm text-xs text-slate-500">
          * “Carregar bolinhas” lê o <code>bubbles.json</code> (raiz → <code>/uploads</code> → API).<br>
          * O filtro por escuridão descarta bolhas que não são realmente preenchidas.
        </div>
      </aside>
    </div>
  </main>

  <script>
    // ===== Configuração de exibição/adição =====
    const MIN_Y = 210;

    // ======= Lógica das bolinhas =======
    const IMAGE_NAME = {{ (imagem_nome or '""')|tojson }};
    const HAS_IMAGE = Boolean({{ 'true' if imagem_url else 'false' }});

    const img = document.getElementById('sheet');
    const svg = document.getElementById('overlay');
    const btnAdd = document.getElementById('btnAdd');
    const btnDetect = document.getElementById('btnDetect');
    const btnToggleAll = document.getElementById('btnToggleAll');
    const btnSave = document.getElementById('btnSave');
    const btnDownload = document.getElementById('btnDownload');
    const btnReload = document.getElementById('btnReload');
    const radius = document.getElementById('radius');
    const radiusVal = document.getElementById('radiusVal');
    const chkFilter = document.getElementById('chkFilter');
    const statusEl = document.getElementById('status');

    const btnPrev = document.getElementById('btnPrev');
    const btnNext = document.getElementById('btnNext');

    let bubbles = []; // {x,y,r,active:true}
    let addMode = false;
    let shadeLayer = null;
    let dotsLayer  = null;

    // ======= Gabarito transcrito =======
    const gabaritoBox = document.getElementById('gabaritoBox');
    const letrasValidas = ['A','B','C','D','E'];
    let gabarito = Array.from({length:60}, (_,i)=> letrasValidas[i%5]);
    let focoAtual = 1;

    function buildGabaritoUI(){
      gabaritoBox.innerHTML = '';
      for (let i=1;i<=60;i++){
        const wrap = document.createElement('div');
        wrap.className = 'mb-2 break-inside-avoid flex items-center gap-2';

        const label = document.createElement('label');
        label.className = 'text-sm text-slate-700 w-10';
        label.textContent = `${i}:`;
        label.setAttribute('for', `q${i}`);

        const input = document.createElement('input');
        input.id = `q${i}`;
        input.className = 'q-input rounded-md border border-slate-300 px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500';
        input.maxLength = 1;
        input.value = gabarito[i-1] || '';
        input.placeholder = 'A–E';
        input.autocomplete = 'off';
        input.inputMode = 'text';

        input.addEventListener('input', (e) => {
          const v = (e.target.value || '').toUpperCase().replace(/[^A-E]/g,'');
          e.target.value = v;
          gabarito[i-1] = v;
        });
        input.addEventListener('focus', ()=> { focoAtual = i; });
        input.addEventListener('keydown', (e)=>{
          if (e.key === 'Enter' || e.key === 'ArrowRight') {
            e.preventDefault();
            focusQuestao(Math.min(60, i+1));
          }
          if (e.key === 'ArrowLeft') {
            e.preventDefault();
            focusQuestao(Math.max(1, i-1));
          }
        });

        wrap.appendChild(label);
        wrap.appendChild(input);
        gabaritoBox.appendChild(wrap);
      }
    }

    function focusQuestao(n){
      focoAtual = Math.max(1, Math.min(60, n));
      const el = document.getElementById(`q${focoAtual}`);
      if (el){ el.focus(); el.select(); }
    }

    // ======= Helpers =======
    const setStatus = (msg, ok=true) => {
      statusEl.textContent = msg;
      statusEl.className = ok ? 'text-green-700' : 'text-rose-700';
      if (ok) setTimeout(()=>{ statusEl.textContent=''; }, 2500);
    };

    function ensureLayers(){
      if (!shadeLayer || !dotsLayer){
        svg.innerHTML = '';
        shadeLayer = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        shadeLayer.setAttribute('id', 'shadeLayer');
        dotsLayer = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        dotsLayer.setAttribute('id', 'dotsLayer');
        svg.appendChild(shadeLayer);
        svg.appendChild(dotsLayer);
      }
    }

    function renderShade(){
      if (!shadeLayer) return;
      const vb = svg.viewBox.baseVal;
      shadeLayer.innerHTML = '';
      const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      rect.setAttribute('x', vb.x);
      rect.setAttribute('y', vb.y);
      rect.setAttribute('width', vb.width);
      rect.setAttribute('height', MIN_Y);
      rect.setAttribute('fill', 'rgba(0,0,0,0.08)');
      rect.setAttribute('pointer-events', 'none');
      shadeLayer.appendChild(rect);
    }

    function renderDots() {
      ensureLayers();
      dotsLayer.innerHTML = '';
      bubbles.forEach((b) => {
        if ((b.y || 0) < MIN_Y) return;
        const c = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        c.setAttribute('cx', b.x);
        c.setAttribute('cy', b.y);
        c.setAttribute('r', Math.max(4, b.r));
        c.setAttribute('class', 'dot' + (b.active ? '' : ' inactive'));
        c.addEventListener('click', (ev) => {
          if (ev.ctrlKey || ev.metaKey) {
            const idx = bubbles.indexOf(b);
            if (idx >= 0) bubbles.splice(idx, 1);
            renderDots();
            ev.stopPropagation();
            return;
          }
          b.active = !b.active;
          c.setAttribute('class', 'dot' + (b.active ? '' : ' inactive'));
          ev.stopPropagation();
        });
        c.addEventListener('contextmenu', (ev) => ev.preventDefault());
        dotsLayer.appendChild(c);
      });
    }

    function clientToImageCoords(clientX, clientY) {
      const rect = svg.getBoundingClientRect();
      const viewBox = svg.viewBox.baseVal;
      const sx = viewBox.width / rect.width;
      const sy = viewBox.height / rect.height;
      return {
        x: viewBox.x + (clientX - rect.left) * sx,
        y: (viewBox.y || 0) + (clientY - rect.top) * sy
      };
    }

    function handleOverlayClick(ev) {
      if (!addMode) return;
      if (ev.target.tagName.toLowerCase() !== 'svg') return;
      const { x, y } = clientToImageCoords(ev.clientX, ev.clientY);
      if (y < MIN_Y) {
        setStatus(`Só é permitido adicionar bolinhas a partir de y = ${MIN_Y}px`, false);
        return;
      }
      const r = Math.max(4, parseInt(radius.value || '12', 10));
      bubbles.push({ x, y, r, active: true });
      renderDots();
    }

    function download(filename, text) {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([text], {type:'application/json'}));
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => { URL.revokeObjectURL(a.href); a.remove(); }, 0);
    }

    // ---- FILTRO por escuridão
    let sampleCanvas, sampleCtx, viewW=0, viewH=0;
    function setupSampler() {
      if (!img?.naturalWidth) return;
      sampleCanvas = document.createElement('canvas');
      sampleCanvas.width = img.naturalWidth;
      sampleCanvas.height = img.naturalHeight;
      sampleCtx = sampleCanvas.getContext('2d', { willReadFrequently:true });
      sampleCtx.drawImage(img, 0, 0);
      viewW = img.naturalWidth;
      viewH = img.naturalHeight;
    }

    function meanGrayInDisk(cx, cy, r) {
      const x0 = Math.max(0, Math.floor(cx - r)), y0 = Math.max(0, Math.floor(cy - r));
      const x1 = Math.min(viewW-1, Math.ceil(cx + r)), y1 = Math.min(viewH-1, Math.ceil(cy + r));
      const w = x1 - x0 + 1, h = y1 - y0 + 1;
      if (w<=0 || h<=0) return 255;

      const imgData = sampleCtx.getImageData(x0, y0, w, h).data;
      const rr = r*r; let sum=0, count=0;

      for (let j=0; j<h; j++){
        for (let i=0; i<w; i++){
          const dx = (x0+i) - cx, dy = (y0+j) - cy;
          if (dx*dx + dy*dy <= rr*0.49){
            const k = (j*w + i)*4;
            const R = imgData[k], G = imgData[k+1], B = imgData[k+2];
            const Y = 0.2126*R + 0.7152*G + 0.0722*B;
            sum += Y; count++;
          }
        }
      }
      if (!count) return 255;
      return sum / count;
    }

    function filterCirclesByDarkness(arr, thr=120){
      const chk = document.getElementById('chkFilter');
      if (!chk?.checked) return arr;
      if (!sampleCtx) setupSampler();
      return arr.filter(c => meanGrayInDisk(c.x, c.y, c.r) <= thr);
    }

    // ---- Carregamento do JSON: raiz -> uploads -> API
    async function loadBubblesFromServer() {
      const tryUrls = ['/bubbles.json','/uploads/bubbles.json','/api/bubbles'];
      let data=null, lastErr='';
      for (const url of tryUrls){
        try{
          const resp = await fetch(url, { cache: 'no-store' });
          const json = await resp.json();
          if (!resp.ok) throw new Error(json.error || `Falha em ${url}`);
          data = json; break;
        }catch(e){ lastErr = e.message; }
      }
      if (!data) throw new Error(lastErr || 'Não foi possível carregar bolinhas.');
      const raw = (data.circles || []).map(c => ({...c, active:true}));
      const dark = filterCirclesByDarkness(raw);
      bubbles = dark.filter(c => (c.y || 0) >= MIN_Y);
      renderDots();
      setStatus(`Carregado ${bubbles.length} bolinhas.`, true);
    }

    function bindEvents(){
      document.getElementById('btnAdd')?.addEventListener('click', () => {
        addMode = !addMode;
        btnAdd.classList.toggle('bg-blue-50', addMode);
        btnAdd.classList.toggle('border-blue-300', addMode);
        svg?.classList.toggle('crosshair', addMode);
      });

      btnToggleAll?.addEventListener('click', () => {
        const someActive = bubbles.some(b => b.active);
        bubbles.forEach(b => b.active = !someActive);
        renderDots();
      });

      btnSave?.addEventListener('click', async () => {
        try {
          const active = bubbles.filter(b => b.active).map(({x,y,r}) => ({x,y,r}));
          const nome = document.getElementById('nomeInput')?.value || '';
          const cpf  = document.getElementById('cpfInput')?.value || '';
          const tipo = (document.querySelector('input[name="tipo"]:checked')?.value) || '';
          const cor  = (document.querySelector('input[name="cor"]:checked')?.value) || '';

          const coletado = [];
          for (let i=1;i<=60;i++){
            const val = (document.getElementById(`q${i}`)?.value || '').toUpperCase();
            coletado.push(val);
          }

          const payload = {
            image: IMAGE_NAME || 'image.png',
            circles: active,
            meta: { nome, cpf, tipo, cor, gabaritoTranscrito: coletado }
          };
          const resp = await fetch('/api/bubbles', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
          const data = await resp.json();
          if (!resp.ok || !data.ok) throw new Error(data.error || 'Falha ao salvar');
          setStatus(`Salvo com sucesso (${data.count} bolinhas ativas).`);
        } catch (e) {
          setStatus(`Erro ao salvar: ${e.message}`, false);
        }
      });

      btnDownload?.addEventListener('click', () => {
        const active = bubbles.filter(b => b.active).map(({x,y,r}) => ({x,y,r}));
        const nome = document.getElementById('nomeInput')?.value || '';
        const cpf  = document.getElementById('cpfInput')?.value || '';
        const tipo = (document.querySelector('input[name="tipo"]:checked')?.value) || '';
        const cor  = (document.querySelector('input[name="cor"]:checked')?.value) || '';

        const coletado = [];
        for (let i=1;i<=60;i++){
          const val = (document.getElementById(`q${i}`)?.value || '').toUpperCase();
          coletado.push(val);
        }

        const payload = {
          image: IMAGE_NAME || 'image.png',
          circles: active,
          meta: { nome, cpf, tipo, cor, gabaritoTranscrito: coletado }
        };
        download('bubbles_atualizado.json', JSON.stringify(payload, null, 2));
      });

      btnReload?.addEventListener('click', () => loadBubblesFromServer());
      btnDetect?.addEventListener('click', () => loadBubblesFromServer());
      document.getElementById('chkFilter')?.addEventListener('change', () => loadBubblesFromServer());
      svg?.addEventListener('click', handleOverlayClick);
      document.addEventListener('keydown', (ev) => {
        if (ev.key.toLowerCase() === 'a') btnAdd?.click();
        if (ev.key === 'ArrowLeft') { ev.preventDefault(); focusQuestao(focoAtual-1); }
        if (ev.key === 'ArrowRight'){ ev.preventDefault(); focusQuestao(focoAtual+1); }
      });

      btnPrev?.addEventListener('click', ()=> focusQuestao(focoAtual-1));
      btnNext?.addEventListener('click', ()=> focusQuestao(focoAtual+1));
    }

    function ensureViewBox(){
      if (!img) return;
      const vw = img.naturalWidth || img.width;
      const vh = img.naturalHeight || img.height;
      svg.setAttribute('viewBox', `0 0 ${vw} ${vh}`);
    }

    async function init() {
      buildGabaritoUI();
      focusQuestao(1);

      if (!img) return setStatus('Nenhuma imagem disponível.', false);
      await new Promise(res => {
        if (img.complete) return res();
        img.onload = res;
        img.onerror = res;
      });
      ensureViewBox();
      ensureLayers();
      renderShade();
      bindEvents();
      setupSampler();

      try {
        await loadBubblesFromServer();
      } catch(e){
        setStatus(e.message, false);
      }

      // Ajusta range do raio com base no mediano
      const rs = bubbles.map(b => b.r).sort((a,b)=>a-b);
      const m = rs.length ? Math.round(rs[Math.floor(rs.length/2)]) : 12;
      radius.value = m;
      radiusVal.textContent = m;
      radius.addEventListener('input', () => {
        radiusVal.textContent = radius.value;
      });
    }
    init();
  </script>
</body>
</html>
